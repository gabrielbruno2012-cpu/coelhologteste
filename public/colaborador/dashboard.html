
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Dashboard Colaborador</title><link rel="stylesheet" href="/css/style.css"><script src="https://cdn.jsdelivr.net/npm/chart.js"></script></head><body>
<script>
// Sync admin login -> collaborator login
if (localStorage.getItem('usuario') && !localStorage.getItem('user')) {
    localStorage.setItem('user', localStorage.getItem('usuario'));
}
</script>

<div id="sidebar-container"></div>
<main class="main">
  <div class="header-right"><button class="btn" onclick="logout()">Logout</button></div>
  <h1>Bem-vindo, <span id="username">Colaborador</span></h1>
  <div class="top-cards">
    <div class="top-card card"><div class="small">Total Recebido</div><div id="total_recebido" class="huge">R$ 0,00</div></div>
    <div class="top-card card"><div class="small">Total Pendente</div><div id="total_pendente" class="huge">R$ 0,00</div></div>
    <div class="top-card card"><div class="small">Em Processamento</div><div id="total_processamento" class="huge">R$ 0,00</div></div>
  </div>
  <div class="card"><h3>Ganhos no Mês</h3><div style="height:220px"><canvas id="barChart"></canvas></div></div>
  <div class="card"><h3>Recebíveis</h3><div id="recList"></div></div>
</main>

<script>
fetch('/components/sidebar.html').then(r=>r.text()).then(html=> document.getElementById('sidebar-container').innerHTML = html);

function logout(){ localStorage.removeItem('user'); window.location = '/'; }

function fmt(v){ return 'R$ ' + Number(v||0).toLocaleString('pt-BR', {minimumFractionDigits:2,maximumFractionDigits:2}); }

window._barChart = null;

async function loadDashboard(){
  const user = JSON.parse(localStorage.getItem('user')||'{}');
  if(!user || !user.id){ window.location='/'; return; }
  document.getElementById('username').innerText = user.nome || user.email;
  // fetch recebiveis for this user
  const res = await fetch('/api/recebiveis?user_id='+user.id);
  const rows = await res.json();
  // totals
  let total=0, pend=0, proc=0;
  rows.forEach(r=>{
    const v = parseFloat(String(r.valor||0).replace(',','.'))||0;
    const st = (r.status||'').toLowerCase();
    if(st.includes('pago')) total += v;
    if(st.includes('pend')) pend += v;
    if(st.includes('process')) proc += v;
  });
  document.getElementById('total_recebido').innerText = fmt(total);
  document.getElementById('total_pendente').innerText = fmt(pend);
  document.getElementById('total_processamento').innerText = fmt(proc);
  // table
  if(rows.length===0){ document.getElementById('recList').innerHTML='<p class="small">Nenhum recebível.</p>'; }
  else{
    let html = '<table class="table"><tr><th>ID</th><th>Data</th><th>Valor</th><th>Tipo</th><th>Status</th></tr>';
    rows.forEach(r=> html += `<tr><td>${r.id}</td><td>${r.data||''}</td><td>R$ ${r.valor}</td><td>${r.tipo||''}</td><td>${r.status||''}</td></tr>`);
    html += '</table>';
    document.getElementById('recList').innerHTML = html;
  }
  // chart: group paid by month
  const byMonth = {};
  rows.forEach(r=>{
    const st = (r.status||'').toLowerCase();
    if(!st.includes('pago')) return;
    const date = r.data ? r.data.split(' ')[0] : r.data;
    let m = '0';
    if(date && date.indexOf('-')>0){ m = date.split('-')[1]; }
    if(!m) m='0';
    byMonth[m] = (byMonth[m]||0) + (parseFloat(String(r.valor||0).replace(',','.'))||0);
  });
  const months = Object.keys(byMonth).sort();
  const labels = months.map(m => ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'][parseInt(m,10)-1]||m);
  const data = months.map(m => byMonth[m]||0);
  const ctx = document.getElementById('barChart').getContext('2d');
  if(window._barChart) window._barChart.destroy();
  window._barChart = new Chart(ctx, { type:'bar', data:{ labels:labels, datasets:[{ label:'Ganhos (R$)', data:data, backgroundColor:'#F6C21B', borderRadius:6 }] }, options:{ scales:{ y:{ beginAtZero:true, ticks:{ callback: v => 'R$ ' + v } } }, plugins:{ legend:{ display:false } }, responsive:true, maintainAspectRatio:false } });
}

// expose for other pages to call after creating/updating recibiveis
window.loadDashboard = loadDashboard;

document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body></html>
